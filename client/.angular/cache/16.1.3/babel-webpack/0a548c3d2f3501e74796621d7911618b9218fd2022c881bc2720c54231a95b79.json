{"ast":null,"code":"// Decorators and Lifehooks\nimport { TemplateRef } from '@angular/core';\n// Router\nimport { Router } from '@angular/router';\n// Forms\nimport { FormControl, FormGroup, Validators } from '@angular/forms';\nimport { debounceTime, distinctUntilChanged } from 'rxjs/operators';\n// Services\nimport { CartService } from '../../services/cart.service';\nimport { HelperService } from '../../services/helper.service';\nimport { BsModalService } from 'ngx-bootstrap/modal';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"@angular/router\";\nimport * as i2 from \"../../services/cart.service\";\nimport * as i3 from \"../../services/helper.service\";\nimport * as i4 from \"ngx-bootstrap/modal\";\nimport * as i5 from \"@angular/common\";\nimport * as i6 from \"@angular/forms\";\nfunction CartComponent_div_0_div_13_div_24_div_1_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\");\n    i0.ɵɵtext(1, \" Quantity is required \");\n    i0.ɵɵelementEnd();\n  }\n}\nfunction CartComponent_div_0_div_13_div_24_div_2_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\");\n    i0.ɵɵtext(1, \" Quantity must be between 1 and 20 \");\n    i0.ɵɵelementEnd();\n  }\n}\nfunction CartComponent_div_0_div_13_div_24_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\", 29);\n    i0.ɵɵtemplate(1, CartComponent_div_0_div_13_div_24_div_1_Template, 2, 0, \"div\", 0);\n    i0.ɵɵtemplate(2, CartComponent_div_0_div_13_div_24_div_2_Template, 2, 0, \"div\", 0);\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    const b_r5 = i0.ɵɵnextContext().$implicit;\n    const ctx_r6 = i0.ɵɵnextContext(2);\n    i0.ɵɵadvance(1);\n    i0.ɵɵproperty(\"ngIf\", ctx_r6.getControl(b_r5._id).errors.required);\n    i0.ɵɵadvance(1);\n    i0.ɵɵproperty(\"ngIf\", ctx_r6.getControl(b_r5._id).errors.min || ctx_r6.getControl(b_r5._id).errors.max);\n  }\n}\nfunction CartComponent_div_0_div_13_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r11 = i0.ɵɵgetCurrentView();\n    i0.ɵɵelementStart(0, \"div\", 13)(1, \"div\", 14)(2, \"div\", 15);\n    i0.ɵɵelement(3, \"img\", 16);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(4, \"div\", 17)(5, \"h4\", 18)(6, \"strong\");\n    i0.ɵɵtext(7);\n    i0.ɵɵelementEnd()();\n    i0.ɵɵelementStart(8, \"h4\")(9, \"small\");\n    i0.ɵɵtext(10);\n    i0.ɵɵelementEnd()()();\n    i0.ɵɵelementStart(11, \"div\", 19)(12, \"div\", 20)(13, \"h6\")(14, \"strong\");\n    i0.ɵɵtext(15);\n    i0.ɵɵelementStart(16, \"span\", 21);\n    i0.ɵɵtext(17, \"x\");\n    i0.ɵɵelementEnd()()()();\n    i0.ɵɵelementStart(18, \"div\", 22)(19, \"div\", 23);\n    i0.ɵɵelement(20, \"input\", 24);\n    i0.ɵɵelementEnd()();\n    i0.ɵɵelementStart(21, \"div\", 25)(22, \"button\", 26);\n    i0.ɵɵlistener(\"click\", function CartComponent_div_0_div_13_Template_button_click_22_listener() {\n      const restoredCtx = i0.ɵɵrestoreView(_r11);\n      const b_r5 = restoredCtx.$implicit;\n      const ctx_r10 = i0.ɵɵnextContext(2);\n      const _r1 = i0.ɵɵreference(2);\n      return i0.ɵɵresetView(ctx_r10.openRemoveModal(_r1, b_r5._id));\n    });\n    i0.ɵɵelement(23, \"i\", 27);\n    i0.ɵɵelementEnd()()()();\n    i0.ɵɵtemplate(24, CartComponent_div_0_div_13_div_24_Template, 3, 2, \"div\", 28);\n    i0.ɵɵelementEnd();\n  }\n  if (rf & 2) {\n    const b_r5 = ctx.$implicit;\n    const ctx_r4 = i0.ɵɵnextContext(2);\n    i0.ɵɵadvance(3);\n    i0.ɵɵpropertyInterpolate(\"src\", b_r5.cover, i0.ɵɵsanitizeUrl);\n    i0.ɵɵadvance(4);\n    i0.ɵɵtextInterpolate(b_r5.title);\n    i0.ɵɵadvance(3);\n    i0.ɵɵtextInterpolate(b_r5.author);\n    i0.ɵɵadvance(5);\n    i0.ɵɵtextInterpolate1(\" \", b_r5.price, \" \");\n    i0.ɵɵadvance(5);\n    i0.ɵɵpropertyInterpolate(\"name\", b_r5._id);\n    i0.ɵɵpropertyInterpolate(\"formControlName\", b_r5._id);\n    i0.ɵɵadvance(4);\n    i0.ɵɵproperty(\"ngIf\", ctx_r4.getControl(b_r5._id).invalid && (ctx_r4.getControl(b_r5._id).dirty || ctx_r4.getControl(b_r5._id).touched));\n  }\n}\nfunction CartComponent_div_0_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r13 = i0.ɵɵgetCurrentView();\n    i0.ɵɵelementStart(0, \"div\")(1, \"form\", 2, 3)(3, \"div\", 4)(4, \"div\", 5);\n    i0.ɵɵelement(5, \"i\", 6);\n    i0.ɵɵtext(6, \" Shopping Cart \");\n    i0.ɵɵelementStart(7, \"div\", 7);\n    i0.ɵɵtext(8, \" Total price: \");\n    i0.ɵɵelementStart(9, \"b\");\n    i0.ɵɵtext(10);\n    i0.ɵɵpipe(11, \"number\");\n    i0.ɵɵelementEnd()();\n    i0.ɵɵelement(12, \"div\", 8);\n    i0.ɵɵelementEnd();\n    i0.ɵɵtemplate(13, CartComponent_div_0_div_13_Template, 25, 7, \"div\", 9);\n    i0.ɵɵelementStart(14, \"div\", 10)(15, \"div\", 7)(16, \"div\", 7);\n    i0.ɵɵtext(17, \" Total price: \");\n    i0.ɵɵelementStart(18, \"b\");\n    i0.ɵɵtext(19);\n    i0.ɵɵpipe(20, \"number\");\n    i0.ɵɵelementEnd()();\n    i0.ɵɵelementStart(21, \"input\", 11);\n    i0.ɵɵlistener(\"click\", function CartComponent_div_0_Template_input_click_21_listener() {\n      i0.ɵɵrestoreView(_r13);\n      const ctx_r12 = i0.ɵɵnextContext();\n      return i0.ɵɵresetView(ctx_r12.onSubmit());\n    });\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(22, \"a\", 12);\n    i0.ɵɵtext(23, \" Continue shopping \");\n    i0.ɵɵelementEnd()()()()()();\n  }\n  if (rf & 2) {\n    const ctx_r0 = i0.ɵɵnextContext();\n    i0.ɵɵadvance(1);\n    i0.ɵɵproperty(\"formGroup\", ctx_r0.cartForm);\n    i0.ɵɵadvance(9);\n    i0.ɵɵtextInterpolate1(\"\", i0.ɵɵpipeBind2(11, 5, ctx_r0.cart.totalPrice, \"1.2-2\"), \"$\");\n    i0.ɵɵadvance(3);\n    i0.ɵɵproperty(\"ngForOf\", ctx_r0.cart.books);\n    i0.ɵɵadvance(6);\n    i0.ɵɵtextInterpolate1(\"\", i0.ɵɵpipeBind2(20, 8, ctx_r0.cart.totalPrice, \"1.2-2\"), \"$\");\n    i0.ɵɵadvance(2);\n    i0.ɵɵproperty(\"disabled\", ctx_r0.cartForm.invalid);\n  }\n}\nfunction CartComponent_ng_template_1_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r15 = i0.ɵɵgetCurrentView();\n    i0.ɵɵelementStart(0, \"div\", 30)(1, \"p\");\n    i0.ɵɵtext(2, \"Do you really want to remove this book from cart?\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(3, \"button\", 31);\n    i0.ɵɵlistener(\"click\", function CartComponent_ng_template_1_Template_button_click_3_listener() {\n      i0.ɵɵrestoreView(_r15);\n      const ctx_r14 = i0.ɵɵnextContext();\n      return i0.ɵɵresetView(ctx_r14.onRemove());\n    });\n    i0.ɵɵtext(4, \"Yes\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(5, \"button\", 32);\n    i0.ɵɵlistener(\"click\", function CartComponent_ng_template_1_Template_button_click_5_listener() {\n      i0.ɵɵrestoreView(_r15);\n      const ctx_r16 = i0.ɵɵnextContext();\n      return i0.ɵɵresetView(ctx_r16.removeModalRef.hide());\n    });\n    i0.ɵɵtext(6, \"No\");\n    i0.ɵɵelementEnd()();\n  }\n}\nexport let CartComponent = /*#__PURE__*/(() => {\n  class CartComponent {\n    constructor(router, cartService, helperService, modalService) {\n      this.router = router;\n      this.cartService = cartService;\n      this.helperService = helperService;\n      this.modalService = modalService;\n    }\n    ngOnInit() {\n      this.cartService.getCart().subscribe(res => {\n        this.cart = res.data;\n        this.cartForm = this.toFormGroup(this.cart.books);\n        this.onChanges();\n      });\n    }\n    ngOnDestroy() {\n      this.changesSub$.unsubscribe();\n    }\n    toFormGroup(books) {\n      const group = {};\n      books.forEach(book => {\n        group[book._id] = new FormControl(book.qty || '', [Validators.required, Validators.min(1), Validators.max(20)]);\n      });\n      return new FormGroup(group);\n    }\n    onChanges() {\n      this.changesSub$ = this.cartForm.valueChanges.pipe(debounceTime(800), distinctUntilChanged()).subscribe(val => {\n        if (this.lastCartState !== JSON.stringify(val)) {\n          this.lastCartState = JSON.stringify(val);\n          this.reCalcSum(val);\n        }\n      });\n    }\n    openRemoveModal(template, id) {\n      this.lastDeleteId = id;\n      this.removeModalRef = this.modalService.show(template, {\n        class: 'myModal modal-sm'\n      });\n    }\n    onRemove() {\n      this.cartService.removeFromCart(this.lastDeleteId).subscribe(() => {\n        this.helperService.cartStatus.next('remove');\n        this.cart.books = this.cart.books.filter(b => b._id !== this.lastDeleteId);\n        this.reCalcSum(this.cartForm.value);\n        this.removeModalRef.hide();\n      });\n    }\n    onSubmit() {\n      this.cartService.checkout(this.cartForm.value).subscribe(() => {\n        this.helperService.cartStatus.next('updateStatus');\n        this.router.navigate(['/user/purchaseHistory']);\n      });\n    }\n    reCalcSum(formValues) {\n      let price = 0;\n      for (const b of this.cart.books) {\n        price += b.price * formValues[b._id];\n      }\n      this.cart.totalPrice = price;\n    }\n    getControl(id) {\n      return this.cartForm.get(id);\n    }\n  }\n  CartComponent.ɵfac = function CartComponent_Factory(t) {\n    return new (t || CartComponent)(i0.ɵɵdirectiveInject(i1.Router), i0.ɵɵdirectiveInject(i2.CartService), i0.ɵɵdirectiveInject(i3.HelperService), i0.ɵɵdirectiveInject(i4.BsModalService));\n  };\n  CartComponent.ɵcmp = /*@__PURE__*/i0.ɵɵdefineComponent({\n    type: CartComponent,\n    selectors: [[\"app-cart\"]],\n    decls: 3,\n    vars: 1,\n    consts: [[4, \"ngIf\"], [\"remove\", \"\"], [3, \"formGroup\"], [\"formDir\", \"ngForm\"], [1, \"card\", \"shopping-cart\"], [1, \"card-header\", \"bg-dark\", \"text-light\"], [\"aria-hidden\", \"true\", 1, \"fa\", \"fa-shopping-cart\"], [1, \"pull-right\"], [1, \"clearfix\"], [\"class\", \"card-body\", 4, \"ngFor\", \"ngForOf\"], [1, \"card-footer\", \"bg-dark\"], [\"type\", \"submit\", \"value\", \"Checkout\", 1, \"btn\", \"btn-success\", \"pull-right\", 3, \"disabled\", \"click\"], [\"routerLink\", \"/book/store/default\", 1, \"btn\", \"btn-secondary\"], [1, \"card-body\"], [1, \"row\"], [1, \"col-12\", \"col-sm-12\", \"col-md-2\", \"text-center\"], [\"alt\", \"cover\", \"width\", \"100\", \"height\", \"150\", 1, \"img-responsive\", 3, \"src\"], [1, \"col-12\", \"text-sm-center\", \"col-sm-12\", \"text-md-left\", \"col-md-6\"], [1, \"product-name\"], [1, \"col-12\", \"col-sm-12\", \"text-sm-center\", \"col-md-4\", \"text-md-right\", \"row\"], [\"id\", \"book-price\", 1, \"col-3\", \"col-sm-3\", \"col-md-6\", \"text-md-right\"], [1, \"text-muted\"], [1, \"col-4\", \"col-sm-4\", \"col-md-4\"], [1, \"quantity\"], [\"type\", \"number\", \"size\", \"4\", \"step\", \"1\", 1, \"qty\", 3, \"name\", \"formControlName\"], [1, \"col-2\", \"col-sm-2\", \"col-md-2\", \"text-right\"], [1, \"btn\", \"btn-outline-danger\", \"btn-xs\", 3, \"click\"], [\"aria-hidden\", \"true\", 1, \"fa\", \"fa-trash\"], [\"class\", \"alert alert-danger\", 4, \"ngIf\"], [1, \"alert\", \"alert-danger\"], [1, \"modal-body\", \"text-center\"], [\"type\", \"button\", 1, \"btn\", \"btn-default\", 3, \"click\"], [\"type\", \"button\", 1, \"btn\", \"btn-primary\", 3, \"click\"]],\n    template: function CartComponent_Template(rf, ctx) {\n      if (rf & 1) {\n        i0.ɵɵtemplate(0, CartComponent_div_0_Template, 24, 11, \"div\", 0);\n        i0.ɵɵtemplate(1, CartComponent_ng_template_1_Template, 7, 0, \"ng-template\", null, 1, i0.ɵɵtemplateRefExtractor);\n      }\n      if (rf & 2) {\n        i0.ɵɵproperty(\"ngIf\", ctx.cart);\n      }\n    },\n    dependencies: [i5.NgForOf, i5.NgIf, i1.RouterLink, i6.ɵNgNoValidate, i6.DefaultValueAccessor, i6.NumberValueAccessor, i6.NgControlStatus, i6.NgControlStatusGroup, i6.FormGroupDirective, i6.FormControlName, i5.DecimalPipe],\n    styles: [\".shopping-cart[_ngcontent-%COMP%]{width:80%;margin:20px auto}.pull-right[_ngcontent-%COMP%]{margin:5px}.card-body[_ngcontent-%COMP%]{background-color:#313532}#book-price[_ngcontent-%COMP%]{padding-top:10px}.text-muted[_ngcontent-%COMP%]{margin-left:5px}.quantity[_ngcontent-%COMP%]{float:left;margin-right:15px;background-color:#eee;position:relative;width:80px;overflow:hidden}.quantity[_ngcontent-%COMP%]   input[_ngcontent-%COMP%]{margin:0;text-align:center;width:15px;height:15px;padding:0;float:right;color:#000;font-size:20px;border:0;outline:0;background-color:#f6f6f6}.quantity[_ngcontent-%COMP%]   input.qty[_ngcontent-%COMP%]{position:relative;border:0;width:100%;height:40px;padding:10px 25px 10px 10px;text-align:center;font-weight:400;font-size:15px;border-radius:0;background-clip:padding-box}.alert[_ngcontent-%COMP%]{width:25%;float:right;font-size:15px}\"]\n  });\n  return CartComponent;\n})();","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}